name: "CodeQL & Sonar analysis"

on:
  push:
    branches: [ main ]
  pull_request:
    # The branches below must be a subset of the branches above
    branches: [ main ]
  schedule:
    - cron: '28 3 * * 6'

jobs:
  analyze:
    name: Analyze
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        language: [ 'java' ]

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Cache SonarCloud packages
      uses: actions/cache@v1
      with:
        path: ~/.sonar/cache
        key: ${{ runner.os }}-sonar
        restore-keys: ${{ runner.os }}-sonar
    - name: Cache Maven packages
      uses: actions/cache@v1
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2

    # Initializes the CodeQL tools for scanning.
    - name: Initialize CodeQL
      uses: github/codeql-action/init@v1
      with:
        languages: ${{ matrix.language }}
        queries: security-and-quality
    - name: Autobuild
      uses: github/codeql-action/autobuild@v1
    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v1

    - name: Archive codeQl result
      uses: actions/upload-artifact@v2
      with:
        name: codeQl result
        path: /home/runner/work/codeql2sonar-maven-plugin/results/java-builtin.sarif
        retention-days: 10

    - name: convert codeQL results into sonar's generic issues format
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        mvn -B install
        mvn -B codeql2sonar:SonarIssueReporter -Dcodeql2sonar.sarif.inputfile=/home/runner/work/codeql2sonar-maven-plugin/results/java-builtin.sarif -Dcodeql2sonar.sarif.outputfile=/home/runner/work/codeql2sonar-maven-plugin/results/sonar-cql-issues.json

    - name: Archive conversion result
      uses: actions/upload-artifact@v2
      with:
        name: conversion result
        path: /home/runner/work/codeql2sonar-maven-plugin/results/sonar-cql-issues.json
        retention-days: 10

    - name: update Sonar with findings
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      run: mvn -B org.sonarsource.scanner.maven:sonar-maven-plugin:sonar -Dsonar.externalIssuesReportPaths=/home/runner/work/codeql2sonar-maven-plugin/results/sonar-cql-issues.json

    - name: Archive sarif files
      uses: actions/upload-artifact@v2
      with:
        name: Result files (codeQl and converted sonar issues)
        path: |
          /home/runner/work/codeql2sonar-maven-plugin/results/java-builtin.sarif
          /home/runner/work/codeql2sonar-maven-plugin/results/sonar-cql-issues.json
        retention-days: 10
